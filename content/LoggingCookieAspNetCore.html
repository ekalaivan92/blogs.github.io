---
title: "Logging authentication cookies send / received by clients in ASPNetCore"
date: 2023-08-29T22:02:39+05:30
draft: false
url: "logging-authentication-cookies-send-or-received-by-clients-in-aspnetcore"
aliases: "logging-authentication-cookies-send-or-received-by-clients-in-aspnetcore.html"
slug: "logging-authentication-cookies-send-or-received-by-clients-in-aspnetcore"
description: "One time we had an issue that is request from out client passes
authentication for one request but failed for next request which is raised
immediately after the first request to the same URI..."
---

<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a class="text-reset" href="/">Home</a></li>
  
    <li class="breadcrumb-item active" aria-current="page">Logging authentication cookies send / received by clients in ASPNetCore</li>
  </ol>
</nav>

<div class="page-body">
    
    <h2 class="mt-3">Introduction</h2>

    <p>
        Sometime we have to do logging of Cookies for debugging in development site or
        in the production site. We had a situation like that,
    </p>

    <p>
        In our big Web API that serves data to the android client. We used cookie
        authentication for that client and server communication. Authentication of app
        is based on uniquely generated Authentication token. It is happened
        automatically whenever the login required. One time we had an issue that is
        request from our client <em>passes authentication for one request but failed for
        next request</em> which is raised immediately after the first request to the same
        URI. We haven&rsquo;t met that situation in any other apps. that error happened in one
        or two clients only.
    </p>

    <p>
        Then we have started debugging the session, First we have verified that the
        login token is valid or not, that is valid, then we are moved to next step of
        our process. Whatever we did in business side is always looking fine from any
        perspective. We had no idea what is going on. If at all that problem is exists
        in API side, why selected <em>one or two devices having problem not all</em>.
    </p>

    <p>
        Finally, we have landed on the debugging session of what we are getting as
        cookie. because authentication is based on cookie only right. If that submitted
        cookie is valid then problem is in the API side. If the cookie is not what we
        have given to them then the problem is in app side. To do this debug session we
        have started analyzing how to log the cookie, To know/log the cookie we have to
        know following details
    </p>

    <ul>
        <li>Cookie Generated by Server on login</li>

        <li>Cookie Submitted By the Client on Each Request</li>
    </ul>

    <p>
        For, this big question ASP.Net Core provides best solutions. We took
    </p>
    
    <ul>
        <li>Cookie Authentication Events to Know the generated cookie</li>
    
        <li>Middle ware to know the submitted cookie.</li>
    </ul>

    <h2 class="mt-3">Cookie Authentication Events</h2>

    <p>
        AspNetCore Allows subscribing to events raised during cookie authentication. By subscribing
        the cookie authentication events we can know the cookie and its values. Mainly
        this cookie authentication events has following events.
    </p>

    <ul>
        <li>Redirect To Access Denied</li>
        
        <li>Redirect To Login</li>
        
        <li>Redirect To Logout</li>
        
        <li>Redirect To Return URL</li>
        
        <li>Signing In</li>
        
        <li>Signed In</li>
        
        <li>Signed Out</li>
        
        <li>Validate Principal</li>
    </ul>

    <p>
        We have used <code>Redirect To Access Denied</code>, <code> Signed In</code>, <code> Signing In</code> events.
    </p>
    
    <p>
        Finally Our <code>Cookie Authentication Events</code> class looks like this
    </p>

    <pre lang="language-cs" class="rounded">
        <code class="language-cs">
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using System.Threading.Tasks;

namespace Web
{
    public class MyCookieAuthenticationEvents : CookieAuthenticationEvents
    {
        public override Task RedirectToAccessDenied(RedirectContext<CookieAuthenticationOptions> context)
        {
            //Logging The Required Details
            //Request Body has the client submitted cookie, if submitted 
            // Request available in the context. `context.HttpContext.Request`
            return base.RedirectToAccessDenied(context);
        }

        public override Task SigningIn(CookieSigningInContext context)
        {
            //Logging The Required Details
            return base.SigningIn(context);
        }

        public override Task SignedIn(CookieSignedInContext context)
        {            
            //Logging The Required Details
            //Generated new cookie information available here. In the request Body. 
            // Request available in the HttpContext. `context.HttpContext.Request`
            return base.SigningIn(context);
        }
    }
}</code>
    </pre>
    
    <p>
        We have to mention this in the cookie authentication event listener somewhere
        right, This is done in the place where we define cookie authentication schemes.
        In Our approach that is <code>startup.cs</code> class. This authentication configurations
        is done under the <code>ConfigureServices</code> section of <code>startup.cs</code> class.
        Somewhere in the startup class we definitely used something like below,
    </p>

    <pre lang="language-cs" class="rounded">
        <code class="language-cs">
public void ConfigureServices(IServiceCollection services)
{
    ...
    
    services
        .AddAuthentication()
        .AddCookie("<Name Of the Authentication Scheme>", options => 
            { 
                ... 
            });
    ...
}</code>
    </pre>
    
    <p>
        To mention the Cookie authentication Events. we will do the following changes
        on the above code block
    </p>

    <pre lang="language-cs" class="rounded">
        <code class="language-cs">
public void ConfigureServices(IServiceCollection services)
{
    ...
    
    services
        .AddAuthentication()
        .AddCookie("", options => 
            { 
                ...
                options.Events = new MyCookieAuthenticationEvents(); // this is newly added line
            });
    ...
}</code>
    </pre>
    
    <p>
        Now, This will tell us what cookie is generated and related details.
    </p>

    <h2 class="mt-3">Cookie Logging Middleware</h2>

    <p>
        The second big portion of our analysis is logging the cookie. To do this we have
        decided to use middleware. Our cookie logging middleware looks like
    </p>

    <pre lang="language-cs" class="rounded">
        <code class="language-cs">
using System.Threading.Tasks;

namespace Web
{   
    public class MyCookieLogMiddleware
    {
        private readonly RequestDelegate _next;

        public MyCookieLogMiddleware(RequestDelegate next)
        {
            _next = next;
        }

        public async Task Invoke(HttpContext context)
        {
            await _next.Invoke(context);
            
            //Logging the required details
            //Submitted Cookies available in the request. `context.Request.Cookies`
            //Generated or response cookies available in the response header. `context.Response.Headers["Set-Cookie"]`

            //Add your logging code here. Mine was 
            //File.WriteAllText("CookieLogFile.txt", context.Request.Cookies.FirtstOrDefault().ToString());
        }                    
    }
}</code>
    </pre>
    
    <p>
        To work this middleware we have to add it to the <code>Application Builder</code> of our
        application. Which is also possible via the <code>startup.cs</code> class. This
        <code>Startup.cs</code> class has the <code>Configure</code> method. this can done easily by having
        middleware extension.
    </p>

    <pre lang="language-cs" class="rounded">
        <code class="language-cs">
public static class MiddlewareExtensions
{
    public static IApplicationBuilder UseMyCookieLogMiddleware(this IApplicationBuilder instance)
    {
        return instance.UseMiddleware&lt;MyCookieLogMiddleware&gt;();
    }
}</code>
    </pre>
    
    <p>
        Finally In <code>startup.cs</code>
    </p>

    <pre lang="language-cs" class="rounded">
        <code class="language-cs">
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
    ...
	app.UseAuthentication();
	app.UseCookieLogMiddleware(); //this is the line we have to include.
    ...
    app.UseMvc();
}</code>
    </pre>
    
    <p>
        This cookie logging middleware should be presented between <code>Use Authentication</code>
        / <code>Use Authorization</code> and <code>UseMvc</code> middleware definitions.
    </p>

    <p>
        Done! Now we will see the logs of cookies wherever we have logged it.
    </p>

    <hr class="my-4" />

    <p>
        <em>Written On: </em><em><strong>on may 30, 2021</strong></em>
    </p>
</div>

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a class="text-reset" href="/">
        <span class="fa fa-caret-left fa-1x"></span>
        Back to Home
        </a></li>
    </ol>
</nav>
